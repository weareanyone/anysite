
function PxLoader(settings){settings=settings||{};if(settings.statusInterval==null){settings.statusInterval=5000;}
if(settings.loggingDelay==null){settings.loggingDelay=20*1000;}
if(settings.noProgressTimeout==null){settings.noProgressTimeout=Infinity;}
var entries=[],progressListeners=[],timeStarted,progressChanged=+new Date;var ResourceState={QUEUED:0,WAITING:1,LOADED:2,ERROR:3,TIMEOUT:4};var ensureArray=function(val){if(val==null){return[];}
if(Array.isArray(val)){return val;}
return[val];};this.add=function(resource){resource.tags=new PxLoaderTags(resource.tags);if(resource.priority==null){resource.priority=Infinity;}
entries.push({resource:resource,state:ResourceState.QUEUED});};this.addProgressListener=function(callback,tags){progressListeners.push({callback:callback,tags:new PxLoaderTags(tags)});};this.addCompletionListener=function(callback,tags){progressListeners.push({tags:new PxLoaderTags(tags),callback:function(e){if(e.completedCount===e.totalCount){callback();}}});};var getResourceSort=function(orderedTags){orderedTags=ensureArray(orderedTags);var getTagOrder=function(entry){var resource=entry.resource,bestIndex=Infinity;for(var i=0;i<resource.tags.length;i++){for(var j=0;j<Math.min(orderedTags.length,bestIndex);j++){if(resource.tags[i]==orderedTags[j]&&j<bestIndex){bestIndex=j;if(bestIndex===0)break;}
if(bestIndex===0)break;}}
return bestIndex;};return function(a,b){var aOrder=getTagOrder(a),bOrder=getTagOrder(b);if(aOrder<bOrder)return-1;if(aOrder>bOrder)return 1;if(a.priority<b.priority)return-1;if(a.priority>b.priority)return 1;return 0;}};this.start=function(orderedTags){timeStarted=+new Date;var compareResources=getResourceSort(orderedTags);entries.sort(compareResources);for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];entry.status=ResourceState.WAITING;entry.resource.start(this);}
setTimeout(statusCheck,100);};var statusCheck=function(){var checkAgain=false,noProgressTime=(+new Date)-progressChanged,timedOut=(noProgressTime>=settings.noProgressTimeout),shouldLog=(noProgressTime>=settings.loggingDelay);for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];if(entry.status!==ResourceState.WAITING){continue;}
entry.resource.checkStatus();if(entry.status===ResourceState.WAITING){if(timedOut){entry.resource.onTimeout();}
else{checkAgain=true;}}}
if(shouldLog&&checkAgain){log();}
if(checkAgain){setTimeout(statusCheck,settings.statusInterval);}};this.isBusy=function(){for(var i=0,len=entries.length;i<len;i++){if(entries[i].status===ResourceState.QUEUED||entries[i].status===ResourceState.WAITING){return true;}}
return false;};var onProgress=function(resource,statusType){var entry=null;for(var i=0,len=entries.length;i<len;i++){if(entries[i].resource===resource){entry=entries[i];break;}}
if(entry==null||entry.status!==ResourceState.WAITING){return;}
entry.status=statusType;progressChanged=+new Date;var numResourceTags=resource.tags.length;for(var i=0,numListeners=progressListeners.length;i<numListeners;i++){var listener=progressListeners[i],shouldCall;if(listener.tags.length===0){shouldCall=true;}
else{shouldCall=resource.tags.contains(listener.tags);}
if(shouldCall){sendProgress(entry,listener);}}};this.onLoad=function(resource){onProgress(resource,ResourceState.LOADED);};this.onError=function(resource){onProgress(resource,ResourceState.ERROR);};this.onTimeout=function(resource){onProgress(resource,ResourceState.TIMEOUT);};var sendProgress=function(updatedEntry,listener){var completed=0,total=0;for(var i=0,len=entries.length;i<len;i++){var entry=entries[i],includeResource=false;if(listener.tags.length===0){includeResource=true;}
else{includeResource=entry.resource.tags.contains(listener.tags);}
if(includeResource){total++;if(entry.status===ResourceState.LOADED||entry.status===ResourceState.ERROR||entry.status===ResourceState.TIMEOUT){completed++;}}}
listener.callback({resource:updatedEntry.resource,loaded:(updatedEntry.status===ResourceState.LOADED),error:(updatedEntry.status===ResourceState.ERROR),timeout:(updatedEntry.status===ResourceState.TIMEOUT),completedCount:completed,totalCount:total});};var log=this.log=function(showAll){if(!window.console){return;}
var elapsedSeconds=Math.round((+new Date-timeStarted)/1000);window.console.log('PxLoader elapsed: '+elapsedSeconds+' sec');for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];if(!showAll&&entry.status!==ResourceState.WAITING){continue;}
var message='PxLoader: #'+i+' '+entry.resource.getName();switch(entry.status){case ResourceState.QUEUED:message+=' (Not Started)';break;case ResourceState.WAITING:message+=' (Waiting)';break;case ResourceState.LOADED:message+=' (Loaded)';break;case ResourceState.ERROR:message+=' (Error)';break;case ResourceState.TIMEOUT:message+=' (Timeout)';break;}
if(entry.resource.tags.length>0){message+=' Tags: ['+entry.resource.tags.join(',')+']';}
window.console.log(message);}};}
function PxLoaderTags(values){this.array=[];this.object={};this.value=null;this.length=0;if(values!==null&&values!==undefined){if(Array.isArray(values)){this.array=values;}else if(typeof values==='object'){for(var key in values){this.array.push(key);}}else{this.array.push(values);this.value=values;}
this.length=this.array.length;for(var i=0;i<this.length;i++){this.object[this.array[i]]=true;}}
this.contains=function(other){if(this.length===0||other.length===0){return false;}else if(this.length===1){if(other.length===1){return this.value===other.value;}else{return other.object.hasOwnProperty(this.value);}}else if(other.length<this.length){return other.contains(this);}else{for(var key in this.object){if(other.object[key]){return true;}}
return false;}}}
if(!Array.isArray){Array.isArray=function(arg){return Object.prototype.toString.call(arg)=='[object Array]';};}
function PxLoaderImage(url,tags,priority){var self=this,loader=null;this.img=new Image();this.tags=tags;this.priority=priority;var onReadyStateChange=function(){if(self.img.readyState=='complete'){removeEventHandlers();loader.onLoad(self);}};var onLoad=function(){removeEventHandlers();loader.onLoad(self);};var onError=function(){removeEventHandlers();loader.onError(self);};var removeEventHandlers=function(){self.unbind('load',onLoad);self.unbind('readystatechange',onReadyStateChange);self.unbind('error',onError);};this.start=function(pxLoader){loader=pxLoader;self.bind('load',onLoad);self.bind('readystatechange',onReadyStateChange);self.bind('error',onError);self.img.src=url;};this.checkStatus=function(){if(self.img.complete){removeEventHandlers();loader.onLoad(self);}};this.onTimeout=function(){removeEventHandlers();if(self.img.complete){loader.onLoad(self);}
else{loader.onTimeout(self);}};this.getName=function(){return url;};this.bind=function(eventName,eventHandler){if(self.img.addEventListener){self.img.addEventListener(eventName,eventHandler,false);}else if(self.img.attachEvent){self.img.attachEvent('on'+eventName,eventHandler);}};this.unbind=function(eventName,eventHandler){if(self.img.removeEventListener){self.img.removeEventListener(eventName,eventHandler,false);}else if(self.img.detachEvent){self.img.detachEvent('on'+eventName,eventHandler);}};}
PxLoader.prototype.addImage=function(url,tags,priority){var imageLoader=new PxLoaderImage(url,tags,priority);this.add(imageLoader);return imageLoader.img;};